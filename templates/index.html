{% extends "base.html" %}

{% block title %}Clean Mail - Email Organization Rules{% endblock %}

{% block content %}

<section>
    <h2>üîç Debug Tools</h2>
    
    <div style="background: #f0f0f0; padding: 20px; border-radius: 8px;">
        <p style="margin-bottom: 10px;">Check sender addresses in emails:</p>
        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
            <input type="text" id="debug-keyword" placeholder="Keyword (e.g., VIETCOMBANK)" 
                   style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
            <button class="btn-primary" onclick="debugEmails()" style="min-width: 120px;">
                üîç Sample Emails
            </button>
        </div>
        <div id="debug-results" style="background: white; padding: 15px; border-radius: 6px; max-height: 400px; overflow-y: auto; display: none;">
        </div>
    </div>
</section>

<section>
    <h2>‚öôÔ∏è Settings</h2>
    
    <div class="settings-panel">
        <div class="setting-item">
            <label for="batch-size">Batch Size (emails per scan):</label>
            <input type="number" id="batch-size" value="200" min="50" max="1000" step="50">
            <small>More = faster but more API calls. 200 is recommended for 8000+ emails</small>
        </div>
        
        <div class="setting-item">
            <label for="max-emails">Max Emails to Scan (for testing):</label>
            <input type="number" id="max-emails" value="1000" min="100" step="100">
            <small>Leave empty to scan all. Use this to test rules faster on large inboxes</small>
        </div>
    </div>
</section>

<section>
    <h2>‚úÖ Active Rules</h2>
    
    {% if active_rules %}
        {% for rule in active_rules %}
        <div class="rule-card" data-rule-id="{{ rule.id }}">
            <h3>{{ rule.name }}</h3>
            <p>{{ rule.description }}</p>
            
            <div class="rule-info">
                <strong>üìÅ Target:</strong> <code>{{ rule.target }}</code>
            </div>
            
            <div class="rule-info">
                <strong>üë§ From:</strong> 
                {% for sender in rule.senders %}
                    <span class="badge badge-sender">{{ sender }}</span>
                {% endfor %}
            </div>
            
            <div class="rule-info">
                <strong>üîç Keywords (ALL must match):</strong> 
                {% for keyword in rule.keywords %}
                    <span class="badge badge-keywords">{{ keyword }}</span>
                {% endfor %}
            </div>
            
            {% if rule.exclude_keywords %}
            <div class="rule-info">
                <strong>‚ùå Exclude:</strong> 
                {% for keyword in rule.exclude_keywords %}
                    <span class="badge" style="background: #ffebee; color: #c62828;">{{ keyword }}</span>
                {% endfor %}
            </div>
            {% endif %}
            
            <div class="rule-actions">
                <button class="btn-secondary test-rule-btn" data-rule-id="{{ rule.id }}">
                    üß™ Test
                </button>
                <button class="btn-primary run-rule-btn" data-rule-id="{{ rule.id }}">
                    ‚ñ∂Ô∏è Run
                </button>
            </div>
            
            <div class="result result-{{ rule.id }}"></div>
        </div>
        {% endfor %}
    {% else %}
        <div class="empty">
            <p>No active rules configured yet</p>
        </div>
    {% endif %}
</section>

{% if pending_rules %}
<section>
    <h2>‚è≥ Pending Rules (Inactive)</h2>
    
    {% for rule in pending_rules %}
    <div class="rule-card" style="opacity: 0.6;">
        <h3>{{ rule.name }}</h3>
        <p>{{ rule.description }}</p>
        
        <div class="rule-info">
            <strong>üìÅ Target:</strong> <code>{{ rule.target }}</code>
        </div>
        
        <p style="color: #999; margin-top: 10px;">‚è∏Ô∏è This rule is currently disabled</p>
    </div>
    {% endfor %}
</section>
{% endif %}

<section>
    <h2>üìÅ Folder Management</h2>
    
    <div id="folders-list">
        <p>Loading folders...</p>
    </div>
    
    <p style="color: #999; font-size: 12px; margin-top: 10px;">
        ‚ö†Ô∏è Note: Folder renaming is not supported by Microsoft Graph API
    </p>
</section>

<style>
.settings-panel {
    background: #f0f0f0;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.setting-item {
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 15px;
}

.setting-item label {
    font-weight: 500;
    min-width: 150px;
}

.setting-item input {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    flex: 0 0 120px;
}

.setting-item small {
    color: #999;
    font-size: 12px;
    flex: 1;
}

.folder-item {
    background: #f9f9f9;
    padding: 12px;
    border-radius: 6px;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.folder-item-name {
    flex: 1;
}

.folder-item-count {
    background: #e0e0e0;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    margin: 0 10px;
}

.folder-item-actions {
    display: flex;
    gap: 5px;
}

.folder-item-actions button {
    padding: 6px 10px;
    font-size: 12px;
}
</style>

<script>
// Get batch size from input
function getBatchSize() {
    return parseInt(document.getElementById('batch-size').value) || 200;
}

function getMaxEmails() {
    const val = document.getElementById('max-emails').value;
    return val ? parseInt(val) : null;
}

document.querySelectorAll('.test-rule-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
        const ruleId = this.dataset.ruleId;
        await testRule(ruleId);
    });
});

document.querySelectorAll('.run-rule-btn').forEach(btn => {
    btn.addEventListener('click', async function() {
        const ruleId = this.dataset.ruleId;
        if (confirm('‚ö†Ô∏è This will move emails. Are you sure?')) {
            await runRule(ruleId);
        }
    });
});

async function testRule(ruleId) {
    const resultDiv = document.querySelector(`.result-${ruleId}`);
    const btn = document.querySelector(`[data-rule-id="${ruleId}"].test-rule-btn`);
    
    btn.disabled = true;
    resultDiv.innerHTML = '<div class="loading"></div> Testing...';
    resultDiv.style.display = 'block';
    
    try {
        const response = await fetch('/api/test-rule', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                rule_id: ruleId,
                batch_size: getBatchSize(),
                max_emails: getMaxEmails()
            })
        });
        
        const data = await response.json();
        const result = data.result;
        
        if (data.success) {
            resultDiv.className = `result result-${ruleId} result info`;
            resultDiv.innerHTML = `
                ‚úì Test successful (${result.batches} batch(es))<br>
                <strong>Scanned:</strong> ${result.scanned} emails<br>
                <strong>Would move:</strong> ${result.moved} emails
            `;
        } else {
            resultDiv.className = `result result-${ruleId} result error`;
            resultDiv.innerHTML = `‚úó Error: ${result.message || data.message}`;
        }
    } catch (error) {
        resultDiv.className = `result result-${ruleId} result error`;
        resultDiv.innerHTML = `‚úó Error: ${error.message}`;
    }
    
    btn.disabled = false;
}

async function runRule(ruleId) {
    const resultDiv = document.querySelector(`.result-${ruleId}`);
    const btn = document.querySelector(`[data-rule-id="${ruleId}"].run-rule-btn`);
    
    btn.disabled = true;
    resultDiv.innerHTML = '<div class="loading"></div> Running rule...';
    resultDiv.style.display = 'block';
    
    try {
        const response = await fetch('/api/run-rule', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                rule_id: ruleId,
                dry_run: false,
                batch_size: getBatchSize(),
                max_emails: getMaxEmails()
            })
        });
        
        const data = await response.json();
        const result = data.result;
        
        if (data.success) {
            resultDiv.className = `result result-${ruleId} result success`;
            resultDiv.innerHTML = `
                ‚úì Rule executed successfully (${result.batches} batch(es))<br>
                <strong>Scanned:</strong> ${result.scanned} emails<br>
                <strong>Moved:</strong> ${result.moved} emails
            `;
        } else {
            resultDiv.className = `result result-${ruleId} result error`;
            resultDiv.innerHTML = `‚úó Error: ${result.message || data.message}`;
        }
    } catch (error) {
        resultDiv.className = `result result-${ruleId} result error`;
        resultDiv.innerHTML = `‚úó Error: ${error.message}`;
    }
    
    btn.disabled = false;
}

async function loadFolders() {
    try {
        const response = await fetch('/api/folders');
        const data = await response.json();
        const list = document.getElementById('folders-list');
        
        if (data.folders.length === 0) {
            list.innerHTML = '<p>No custom folders found</p>';
            return;
        }
        
        let html = '';
        for (const folder of data.folders) {
            html += `
                <div class="folder-item">
                    <div class="folder-item-name">üìÅ ${folder.name}</div>
                    <div class="folder-item-count">${folder.message_count} emails</div>
                </div>
            `;
        }
        list.innerHTML = html;
    } catch (error) {
        document.getElementById('folders-list').innerHTML = `<p style="color: red;">Error loading folders: ${error.message}</p>`;
    }
}

async function renameFolder(path) {
    const newName = prompt(`Rename folder to:`);
    if (!newName) return;
    
    try {
        const response = await fetch('/api/rename-folder', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({path, new_name: newName})
        });
        
        const data = await response.json();
        if (data.success) {
            alert('‚úì Folder renamed successfully');
            loadFolders();
        } else {
            alert(`‚úó Error: ${data.message}`);
        }
    } catch (error) {
        alert(`‚úó Error: ${error.message}`);
    }
}

async function debugEmails() {
    const keyword = document.getElementById('debug-keyword').value;
    const resultsDiv = document.getElementById('debug-results');
    
    resultsDiv.style.display = 'block';
    resultsDiv.innerHTML = '<div class="loading"></div> Fetching sample emails...';
    
    try {
        const response = await fetch(`/api/sample-emails?folder=Inbox&limit=10&keyword=${encodeURIComponent(keyword)}`);
        const data = await response.json();
        
        if (data.success && data.samples.length > 0) {
            let html = `<p><strong>Found ${data.samples.length} sample emails:</strong></p>`;
            data.samples.forEach((email, idx) => {
                html += `
                    <div style="padding: 10px; margin: 5px 0; background: #f9f9f9; border-radius: 4px; font-size: 12px;">
                        <strong>${idx + 1}. ${email.subject.substring(0, 80)}</strong><br>
                        <span style="color: #666;">From: <code>${email.sender}</code> (${email.sender_name})</span>
                    </div>
                `;
            });
            resultsDiv.innerHTML = html;
        } else {
            resultsDiv.innerHTML = '<p style="color: #999;">No emails found with that keyword</p>';
        }
    } catch (error) {
        resultsDiv.innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
    }
}

// Check status and load folders on load
window.addEventListener('load', async () => {
    try {
        const response = await fetch('/api/status');
        const data = await response.json();
        
        const statusDiv = document.getElementById('status');
        if (data.authenticated && data.mailbox) {
            statusDiv.innerHTML = '‚úì Connected to Outlook';
        } else {
            statusDiv.innerHTML = '‚úó Not authenticated';
            statusDiv.style.background = '#f8d7da';
        }
    } catch (error) {
        document.getElementById('status').innerHTML = '‚ö†Ô∏è Status check failed';
    }
    
    loadFolders();
});
</script>

{% endblock %}
